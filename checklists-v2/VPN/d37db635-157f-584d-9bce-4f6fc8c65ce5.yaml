description: 'To increase reliability, it''s advised that each ExpressRoute gateway
  connects to at least two circuits, with each circuit originating from a different
  peering location than the other, ensuring diverse connectivity paths for enhanced
  resilience.

  '
guid: d37db635-157f-584d-9bce-4f6fc8c65ce5
labels:
  area: High Availability
  source: azure-resources/Network/virtualNetworkGateways/recommendations.yaml
  sourceType: aprl
links: []
queries:
- arg: "// Azure Resource Graph Query\n// Provides a list of ExpressRoute Gateways\
    \ that are not connected to two or more ExpressRoute Circuits. Baremetal circuits\
    \ are excluded from consideration\n//This query assumes that the running entity\
    \ has visibilty to the gateway, connection, and circuit scopes.\n//Start with\
    \ a full list of gateways\n(resources\n| where type == \"microsoft.network/virtualnetworkgateways\"\
    \n| where properties.gatewayType == \"ExpressRoute\"\n| extend exrGatewayId =\
    \ tolower(tostring(id))\n| join kind=inner(\nresources\n| where type == \"microsoft.network/virtualnetworkgateways\"\
    \n| where properties.gatewayType == \"ExpressRoute\"\n| extend exrGatewayId =\
    \ tolower(tostring(id))\n| join kind=leftouter(\n//connections joined with circuit\
    \ peer info\nresources\n| where type == \"microsoft.network/connections\"\n| extend\
    \ connectionType = properties.connectionType\n| extend exrGatewayId = tolower(tostring(properties.virtualNetworkGateway1.id))\n\
    | extend peerId = tolower(tostring(properties.peer.id))\n| extend connectionId\
    \ = tolower(tostring(id))\n| where connectionType == \"ExpressRoute\"\n| join\
    \ kind=leftouter(\n  resources\n  | where type == \"microsoft.network/expressroutecircuits\"\
    \n    //should this be location instead of peeringLocation\n  | extend circuitId\
    \ = tolower(tostring(id))\n  | extend peeringLocation = tostring(properties.serviceProviderProperties.peeringLocation)\n\
    \  | extend peerId = tolower(id)\n) on peerId ) on exrGatewayId\n//remove bare\
    \ metal services connections/circuits\n| where not(isnotnull(connectionId) and\
    \ isnull(sku1))\n//group by gateway ID's and peering locations\n| summarize by\
    \ exrGatewayId, peeringLocation\n//summarize to connections with fewer than two\
    \ unique connections\n| summarize connCount = count() by exrGatewayId\n| where\
    \ connCount < 2) on exrGatewayId\n| project recommendationId = \"d37db635-157f-584d-9bce-4f6fc8c65ce5\"\
    , name, id, tags, param1 = \"twoOrMoreCircuitsConnectedFromDifferentPeeringLocations:\
    \ false\")\n| union\n(\nresources\n| where type == \"microsoft.network/virtualnetworkgateways\"\
    \n| where properties.gatewayType == \"ExpressRoute\"\n| extend exrGatewayId =\
    \ tolower(tostring(id))\n| join kind=leftouter(\n//connections joined with circuit\
    \ peer info\nresources\n| where type == \"microsoft.network/connections\"\n| extend\
    \ connectionType = properties.connectionType\n| extend exrGatewayId = tolower(tostring(properties.virtualNetworkGateway1.id))\n\
    | extend peerId = tolower(tostring(properties.peer.id))\n| extend connectionId\
    \ = tolower(tostring(id))\n| where connectionType == \"ExpressRoute\") on exrGatewayId\n\
    | where isnull(connectionType)\n| project recommendationId = \"d37db635-157f-584d-9bce-4f6fc8c65ce5\"\
    , name, id, tags, param1 = \"twoOrMoreCircuitsConnectedFromDifferentPeeringLocations:\
    \ false\", param2 = \"noConnectionsOnGateway: true\"\n)\n\n"
resourceTypes:
- Microsoft.Network/virtualNetworkGateways
service: VPN
severity: 0
text: Connect ExpressRoute gateway with circuits from diverse peering locations for
  resilience
