name: revcl-NsgInboundDefaultRulesVirtualnetworkServiceTag
title: Don't rely on the NSG inbound default rules using the VirtualNetwork service
  tag to limit connectivity.
source:
  type: revcl
  file: ./checklists/alz_checklist.en.json
resourceTypes:
- Microsoft.Network/networkSecurityGroups
waf: Security
severity: 1
labels:
  guid: 11deb39d-8299-4e47-bbe0-0fb5a36318a8
  area: Network Topology and Connectivity
  subarea: Segmentation
  id: D09.02
links:
- type: docs
  url: https://learn.microsoft.com/azure/virtual-network/service-tags-overview#available-service-tags
queries:
  arg: resources | where type=='microsoft.network/networksecuritygroups' | mvexpand
    properties.securityRules | project id,name,ruleAction=properties_securityRules.properties.access,rulePriority=properties_securityRules.properties.priority,ruleDst=properties_securityRules.properties.destinationAddressPrefix,ruleSrc=properties_securityRules.properties.sourceAddressPrefix,ruleProt=properties_securityRules.properties.protocol,ruleDirection=properties_securityRules.properties.direction,rulePort=properties_securityRules.properties.destinationPortRange
    | summarize StarDenies=countif(ruleAction=='Deny' and ruleDst=='*' and ruleSrc=='*'
    and ruleProt=='*' and rulePort=='*') by id,tostring(ruleDirection) | where ruleDirection
    == 'Inbound' | project id,compliant=(StarDenies>0) | union (resources | where
    type=='microsoft.network/networksecuritygroups' | where array_length(properties.securityRules)==0
    | extend compliant=false | project id,compliant)
