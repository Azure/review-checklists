name: aprl-AzureCapacityReservationsReserveComputeCapacity
title: Reserve Compute Capacity for critical workloads
description: |-
  Azure Capacity Reservations ensure high availability for virtual machines by reserving compute capacity in advance within a specific region or availability zone. This guarantees that VMs will have the necessary resources during peak demand or maintenance events, enhancing reliability and uptime.
source:
  type: aprl
  file: azure-resources/Compute/virtualMachines/recommendations.yaml
  timestamp: July 24, 2024
resourceTypes:
- Microsoft.Compute/virtualMachines
severity: 0
labels:
  guid: 302fda08-ee65-4fbe-a916-6dc0b33169c4
  area: High Availability
links: []
queries:
  arg: |-
    // Azure Resource Graph Query
    // Find all Virtual Machines not associated with a Capacity Reservation, and provide details for Capacity Reservation like vmSize, location, and zone.
    resources
    | where type =~ 'Microsoft.Compute/virtualMachines'
    | where isnull(properties.capacityReservation)
    | extend zoneValue = iff(isnull(zones), "null", zones)
    | project recommendationId = "302fda08-ee65-4fbe-a916-6dc0b33169c4", name, id, tags, param1 = strcat("VmSize: ", properties.hardwareProfile.vmSize), param2 = strcat("Location: ", location), param3 = strcat("Zone: ", zoneValue)
