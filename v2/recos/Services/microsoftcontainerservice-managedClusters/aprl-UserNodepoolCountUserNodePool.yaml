name: aprl-UserNodepoolCountUserNodePool
title: Configure user nodepool count
description: |-
  Configuring the user node pool with at least two nodes is essential for applications needing high availability, ensuring they remain operational and accessible without interruption.
source:
  type: aprl
  file: azure-resources/ContainerService/managedClusters/recommendations.yaml
  timestamp: July 24, 2024
resourceTypes:
- Microsoft.ContainerService/managedClusters
severity: 0
labels:
  guid: 005ccbbd-aeab-46ef-80bd-9bd4479412ec
  area: High Availability
links: []
queries:
  arg: |
    // Azure Resource Graph Query
    // Returns each AKS cluster with nodepools that have user nodepools with less than 2 nodes
    resources
    | where type == "microsoft.containerservice/managedclusters"
    | mv-expand agentPoolProfile = properties.agentPoolProfiles
    | extend taints = tostring(parse_json(agentPoolProfile.nodeTaints))
    | extend nodePool = tostring(parse_json(agentPoolProfile.name))
    | where taints !has "CriticalAddonsOnly=true:NoSchedule" and  agentPoolProfile.minCount < 2
    | project recommendationId="005ccbbd-aeab-46ef-80bd-9bd4479412ec", id, name, param1=strcat("nodePoolName: ", nodePool), param2=strcat("nodePoolMinNodeCount: ", agentPoolProfile.minCount)
