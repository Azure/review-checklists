name: aprl-PermanentDataLossKeyVaults
title: Key vaults should have purge protection enabled
description: |-
  Purge protection secures against malicious deletions by enforcing a retention period for soft deleted key vaults, ensuring no one, not even insiders or Microsoft, can purge your key vaults during this period, preventing permanent data loss.
source:
  type: aprl
  file: azure-resources/KeyVault/vaults/recommendations.yaml
  timestamp: July 24, 2024
resourceTypes:
- Microsoft.KeyVault/vaults
severity: 1
labels:
  guid: 70fcfe6d-00e9-5544-a63a-fff42b9f2edb
  area: Disaster Recovery
links: []
queries:
  arg: |
    // Azure Resource Graph Query
    // This resource graph query will return all Key Vaults that do not have Purge Protection enabled.
    resources
    | where type == "microsoft.keyvault/vaults"
    | where isnull(properties.enablePurgeProtection) or properties.enablePurgeProtection != "true"
    | project recommendationId = "70fcfe6d-00e9-5544-a63a-fff42b9f2edb", name, id, tags, param1 = "EnablePurgeProtection: Disabled"
