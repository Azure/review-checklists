description: 'Deploying Azure Load Balancers with at least two instances in the backend
  prevents a single point of failure and supports scalability. Pairing with Virtual
  Machine Scale Sets is advised for optimal scale building.

  '
guid: 6d82d042-6d61-ad49-86f0-6a5455398081
labels:
  area: High Availability
  source: azure-resources/Network/loadBalancers/recommendations.yaml
  sourceType: aprl
links: []
queries:
- arg: "// Azure Resource Graph Query\n// Find all LoadBalancers which only have 1\
    \ backend pool defined or only 1 VM in the backend pool\nresources\n| where type\
    \ =~ 'Microsoft.Network/loadBalancers'\n| extend bep = properties.backendAddressPools\n\
    | extend BackEndPools = array_length(bep)\n| where BackEndPools == 0\n| project\
    \ recommendationId = \"6d82d042-6d61-ad49-86f0-6a5455398081\", name, id, Param1=\"\
    backendPools\", Param2=toint(0), tags\n| union (resources\n  | where type =~ 'Microsoft.Network/loadBalancers'\n\
    \  | where sku.name == \"Standard\"\n  | extend bep = properties.backendAddressPools\n\
    \  | extend BackEndPools = toint(array_length(bep))\n  | mv-expand bip = properties.backendAddressPools\n\
    \  | extend BackendAddresses = array_length(bip.properties.loadBalancerBackendAddresses)\n\
    \  | where toint(BackendAddresses) <= 1\n  | project recommendationId = \"6d82d042-6d61-ad49-86f0-6a5455398081\"\
    , name, id, tags, Param1=\"backendAddresses\", Param2=toint(BackendAddresses))\n\
    | union (\n  resources\n  | where type =~ 'Microsoft.Network/loadBalancers'\n\
    \  | where sku.name == \"Basic\"\n  | mv-expand properties.backendAddressPools\n\
    \  | extend backendPoolId = properties_backendAddressPools.id\n  | project id,\
    \ name, tags, tostring(backendPoolId), recommendationId = \"6d82d042-6d61-ad49-86f0-6a5455398081\"\
    , Param1=\"BackEndPools\"\n  | join kind = leftouter (\n  resources\n  | where\
    \ type =~ \"Microsoft.Network/networkInterfaces\"\n  | mv-expand properties.ipConfigurations\n\
    \  | mv-expand properties_ipConfigurations.properties.loadBalancerBackendAddressPools\n\
    \  | extend backendPoolId = tostring(properties_ipConfigurations_properties_loadBalancerBackendAddressPools.id)\n\
    \  | summarize poolMembers = count() by backendPoolId\n  | project tostring(backendPoolId),\
    \ poolMembers ) on backendPoolId\n  | where toint(poolMembers) <= 1\n  | extend\
    \ BackendAddresses = poolMembers\n  | project id, name, tags, recommendationId,\
    \ Param1=\"backendAddresses\", Param2=toint(BackendAddresses))\n"
resourceTypes:
- Microsoft.Network/loadBalancers
service: Load Balancer
severity: 0
text: Ensure the Backend Pool contains at least two instances
