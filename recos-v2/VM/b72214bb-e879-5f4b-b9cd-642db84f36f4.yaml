description: 'VM Insights monitors VM and scale set performance, health, running processes,
  and dependencies. It enhances the predictability of application performance and
  availability by pinpointing performance bottlenecks and network issues, and it clarifies
  if problems are related to other dependencies.

  '
guid: b72214bb-e879-5f4b-b9cd-642db84f36f4
labels:
  area: Monitoring and Alerting
  source: azure-resources/Compute/virtualMachines/recommendations.yaml
  sourceType: aprl
links: []
queries:
- arg: "// Azure Resource Graph Query\n// Check for VMs without Azure Monitoring Agent\
    \ extension installed, missing Data Collection Rule or Data Collection Rule without\
    \ performance enabled.\nResources\n| where type == 'microsoft.compute/virtualmachines'\n\
    | project idVm = tolower(id), name, tags\n| join kind=leftouter (\n    InsightsResources\n\
    \    | where type =~ \"Microsoft.Insights/dataCollectionRuleAssociations\" and\
    \ id has \"Microsoft.Compute/virtualMachines\"\n    | project idDcr = tolower(properties.dataCollectionRuleId),\
    \ idVmDcr = tolower(substring(id, 0, indexof(id, \"/providers/Microsoft.Insights/dataCollectionRuleAssociations/\"\
    ))))\non $left.idVm == $right.idVmDcr\n| join kind=leftouter (\n    Resources\n\
    \    | where type =~ \"Microsoft.Insights/dataCollectionRules\"\n    | extend\n\
    \        isPerformanceEnabled = iif(properties.dataSources.performanceCounters\
    \ contains \"Microsoft-InsightsMetrics\" and properties.dataFlows contains \"\
    Microsoft-InsightsMetrics\", true, false),\n        isMapEnabled = iif(properties.dataSources.extensions\
    \ contains \"Microsoft-ServiceMap\" and properties.dataSources.extensions contains\
    \ \"DependencyAgent\" and properties.dataFlows contains \"Microsoft-ServiceMap\"\
    , true, false)//,\n    | where isPerformanceEnabled or isMapEnabled\n    | project\
    \ dcrName = name, isPerformanceEnabled, isMapEnabled, idDcr = tolower(id))\non\
    \ $left.idDcr == $right.idDcr\n| join kind=leftouter (\n    Resources\n      \
    \  | where type == 'microsoft.compute/virtualmachines/extensions' and (name contains\
    \ 'AzureMonitorWindowsAgent' or name contains 'AzureMonitorLinuxAgent')\n    \
    \    | extend idVmExtension = tolower(substring(id, 0, indexof(id, '/extensions'))),\
    \ extensionName = name)\non $left.idVm == $right.idVmExtension\n| where isPerformanceEnabled\
    \ != 1 or (extensionName != 'AzureMonitorWindowsAgent' and extensionName != 'AzureMonitorLinuxAgent')\n\
    | project recommendationId = \"b72214bb-e879-5f4b-b9cd-642db84f36f4\", name, id\
    \ = idVm, tags, param1 = strcat('MonitoringExtension:', extensionName), param2\
    \ = strcat('DataCollectionRuleId:', idDcr), param3 = strcat('isPerformanceEnabled:',\
    \ isPerformanceEnabled)\n\n"
resourceTypes:
- Microsoft.Compute/virtualMachines
service: VM
severity: 2
text: Enable VM Insights
