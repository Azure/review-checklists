description: |-
  Enabling automatic VM guest patching eases update management by safely, automatically patching virtual machines to maintain security compliance, while limiting blast radius of VMs. Note, the KQL will not return sets using Uniform orchestration.
guid: e4ffd7b0-ba24-c84e-9352-ba4819f908c0
labels:
  area: Other Best Practices
links: []
queries:
  arg: |
    // Azure Resource Graph query
    // Identifies VMs and VMSS with manual patch settings, excluding automatic patch modes
    resources
    | where type == "microsoft.compute/virtualmachinescalesets"
    | join kind=inner (
        resources
        | where type == "microsoft.compute/virtualmachines"
        | project id = tostring(properties.virtualMachineScaleSet.id), vmproperties = properties
    ) on id
    | extend recommendationId = "e4ffd7b0-ba24-c84e-9352-ba4819f908c0", param1 = "patchMode: Manual", vmproperties.osProfile.linuxConfiguration.patchSettings.patchMode
    | where isnotnull(vmproperties.osProfile.linuxConfiguration) and vmproperties.osProfile.linuxConfiguration.patchSettings.patchMode !in ("AutomaticByPlatform", "AutomaticByOS")
    | distinct recommendationId, name, id, param1
    | union (resources
    | where type == "microsoft.compute/virtualmachinescalesets"
    | join kind=inner (
        resources
        | where type == "microsoft.compute/virtualmachines"
        | project id = tostring(properties.virtualMachineScaleSet.id), vmproperties = properties
    ) on id
    | extend recommendationId = "e4ffd7b0-ba24-c84e-9352-ba4819f908c0", param1 = "patchMode: Manual", vmproperties.osProfile.windowsConfiguration.patchSettings.patchMode
    | where isnotnull(vmproperties.osProfile.windowsConfiguration) and vmproperties.osProfile.windowsConfiguration.patchSettings.patchMode !in ("AutomaticByPlatform", "AutomaticByOS")
    | distinct recommendationId, name, id, param1)
resourceTypes:
- Microsoft.Compute/virtualMachineScaleSets
service: VMSS
severity: 2
source:
  file: azure-resources/Compute/virtualMachineScaleSets/recommendations.yaml
  type: aprl
title: Set Patch orchestration options to Azure-orchestrated
