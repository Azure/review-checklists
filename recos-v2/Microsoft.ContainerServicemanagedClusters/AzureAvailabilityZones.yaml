guid: 4f63619f-5001-439c-bacb-8de891287727
name: AzureAvailabilityZones
title: Deploy AKS cluster across availability zones
description: |-
  Azure Availability Zones ensure high availability by offering independent locations within regions, equipped with their own power, cooling, and networking to ensure applications and data are protected from datacenter-level failures.
source:
  type: aprl
  file: azure-resources/ContainerService/managedClusters/recommendations.yaml
  timestamp: July 24, 2024
services:
- Microsoft.ContainerService/managedClusters
resourceTypes:
- Microsoft.ContainerService/managedClusters
severity: 0
labels:
  area: High Availability
links: []
queries:
  arg: |-
    // Azure Resource Graph Query
    // Returns AKS clusters that do not have any availability zones enabled or only use a single zone
    resources
    | where type =~ "Microsoft.ContainerService/managedClusters"
    | project id, name, tags, location, pools = properties.agentPoolProfiles
    | mv-expand pool = pools
    | extend
        numOfAvailabilityZones = iif(isnull(pool.availabilityZones), 0, array_length(pool.availabilityZones))
    | where numOfAvailabilityZones < 2
    | project
        recommendationId = "4f63619f-5001-439c-bacb-8de891287727",
        id,
        name,
        tags,
        param1 = strcat("NodePoolName: ", pool.name),
        param2 = strcat("Mode: ", pool.mode),
        param3 = strcat("AvailabilityZones: ", iif(numOfAvailabilityZones == 0, "None", strcat("Zone ", strcat_array(pool.availabilityZones, ", ")))),
        param4 = strcat("Location: ", location)
