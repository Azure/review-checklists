{
  "items": [
    {
      "category": "VMs and VMSS",
      "subcategory": "Capacity",
      "text": "Create Alerts to monitor and alert on VM quotas for your subscriptions.",
      "description": "VMs have specific limits and quotas, which vary based on the type of VM or the region. There might be subscription restrictions, such as the number of VMs per subscription or the number of cores per VM. If other workloads share your subscription, then your ability to consume data might be reduced.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "dc8ec9d1-bb73-4b26-a5a6-7eba9ed5b354",
      "id": "A01.01",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#virtual-machines-limits",
      "graph": "resources | where type =~ 'microsoft.insights/scheduledqueryrules' | where properties.criteria has 'arg(\"\").QuotaResources' | project id, compliant = true"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Architecture",
      "text": "Conduct a failure mode analysis to minimize points of failure",
      "description": "Analyze VM interactions with the network and storage components. Choose configurations like ephemeral operating system (OS) disks to localize disk access and avoid network hops. Add a load balancer to enhance self-preservation by distributing network traffic across multiple VMs, which improves availability and reliability.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "bc178adc-5a06-4ca7-8443-50d09dd23429",
      "id": "A02.01",
      "severity": "High",
      "link": "https://learn.microsoft.com/azure/aks/use-windows-hpc"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Architecture",
      "text": "Ensure that your composite service level objective isn't higher than the Azure SLA",
      "description": "Calculate your composite service-level objectives (SLOs) based on Azure service-level agreements (SLAs) of all Azure services included in your VM architecture. The lowest SLA of any component service will determine the overall SLO of your architecture. Factor in the critical dependencies of VMs on components like disks and networking components. If you understand these relationships, then you can determine the critical flows that affect reliability.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "20b56c57-be59-4519-8f83-845c586cb291",
      "id": "A02.02",
      "severity": "Medium",
      "link": "https://azure.microsoft.com/support/legal/sla/virtual-machines"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Architecture",
      "text": "Create application and operating system state isolation",
      "description": "Workload data should be on a separate data disk to prevent interference with the OS disk. If a VM fails, you can create a new OS disk with the same data disk, which ensures resilience and fault isolation",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "dc16a1c0-75ef-49f1-91ac-ccd579376bcd",
      "id": "A02.03",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machines/ephemeral-os-disks",
      "graph":"resources | where type =~ 'microsoft.compute/virtualmachines' | extend hasDataDisk = (array_length(properties.storageProfile.dataDisks) < 1) | project id, compliant = hasDataDisk"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Availability",
      "text": "Make VMs and their dependencies redundant across zones",
      "description": "When a VM fails, the workload should continue to function because of redundancy. Include dependencies in your redundancy choices. For example, use the built-in redundancy options that are available with disks. Use zone-redundant IPs to ensure data availability and high uptime.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "b3750ab2-ab0e-49d6-9d15-d3c492adb1b3",
      "id": "A03.01",
      "severity": "High",
      "link": "https://learn.microsoft.com/azure/virtual-machines/availability",
      "graph":"resources | where type =~ 'microsoft.compute/virtualmachines' and isnotempty(zones) | project id, vmZones = zones | join (resources | where type =~ 'microsoft.compute/disks' | project id,managedBy,diskZones = zones) on $left.id == $right.managedBy |project id, compliant = iff(tostring(vmZones) != tostring(diskZones),false,true),vmZones,diskZones"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Availability",
      "text": "Be ready to scale up and scale out to prevent service level degradation and to avoid failures",
      "description": "Virtual Machine Scale Sets have autoscale capabilities that create new instances as required and distribute the load across multiple VMs and availability zones.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "d1325af2-25ca-444e-8685-edddeace4bb1",
      "id": "A03.02",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/overview",
      "graph":"resources| where type == 'microsoft.compute/virtualmachinescalesets' and properties.platformFaultDomainCount == 1 and isnotempty(properties.virtualMachineProfile) and properties.virtualMachineProfile.extensionProfile.extensions !has_cs 'Microsoft.AKS' and properties.virtualMachineProfile.extensionProfile.extensions !has_cs 'Microsoft.Azure.ServiceFabric'| project id, subscriptionId| join kind=leftouter ( resources | where type == 'microsoft.insights/autoscalesettings'  and tostring(properties.targetResourceUri) has 'Microsoft.Compute/virtualMachineScaleSets'  and properties.enabled == 'true' | mv-expand profile=properties.profiles | where array_length(profile.rules) != 0 | distinct tostring(properties.targetResourceUri) | project targetResourceUri = properties_targetResourceUri ) on $left.id == $right.targetResourceUri| project id,compliant = iff( isempty(targetResourceUri),false,true) "    
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Availability",
      "text": "Explore the automatic recovery options",
      "description": "Azure supports health degradation monitoring and self-healing features for VMs. For example, scale sets provide automatic instance repairs. In more advanced scenarios, self-healing involves using Azure Site Recovery, having a passive standby to fail over to, or redeploying from infrastructure as code (IaC). The method that you choose should align with the business requirements and your organizational operations. For more information, see VM service disruptions",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "01d6e872-e52e-4361-8cd5-8b5a4b1511e4",
      "id": "A03.03",
      "severity": "Medium",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' | where isnotnull(properties.virtualMachineProfile) | project id, compliant = iff( isnull(properties.automaticRepairsPolicy) or properties.automaticRepairsPolicy.enabled == false,false,true)"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Capacity",
      "text": "Rightsize the VMs and their dependencies",
      "description": "Understand your VM's expected work to ensure it's not undersized and can handle the maximum load. Have extra capacity to mitigate failures.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "3a58a9c2-299c-44d7-a67d-0c655562f2b3",
      "id": "A04.01",
      "severity": "Medium",
      "graph": "advisorresources | where properties.recommendationTypeId in ('84b1a508-fc21-49da-979e-96894f1665df') | project subscriptionId,compliant = false"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Operations",
      "text": "Create and test a comprehensive disaster recovery plan",
      "description": "Dependencies and stateful components, such as attached storage, can complicate recovery. If disks go down, then that failure affects the VM's functioning. Include a clear process for these dependencies in your recovery plans",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "e4563a4d-8739-4748-a662-d6d15f512a65",
      "id": "A05.01",
      "severity": "Low"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Operations",
      "text": "Run operations with rigor",
      "description": "Reliability design choices must be supported by effective operations based on the principles of monitoring, resiliency testing in production, automated application VM patches and upgrades, and consistency of deployments",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "498f6dfe-237d-4e24-9b16-c31d7aa9b647",
      "id": "A05.02",
      "severity": "Medium"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Availability",
      "text": "Use Virtual Machine Scale Sets in Flexible orchestration mode to deploy VMs",
      "description": "Deploying VMs, even those which are initially standalone, into flexible orchestration mode VMSSes enables future scaling and ensures the newest VMSS features are available",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "0448aa80-52d8-48e7-ad17-b73b22a5a67e",
      "id": "A06.01",
      "severity": "Medium",
      "graph": "resources | where type == 'microsoft.compute/virtualmachines' | project id, compliant = iff(isempty(properties.virtualMachineScaleSet.id),false,true)"
    },
    {
      "category": "VMS and VMSS",
      "subcategory": "Availability",
      "text": "Expose VM workload health to the Azure platform to enable monitoring and repair options",
      "description": "By exposing your VM workload's health to the Azure platform, such as with the Application Health extension, you enable health status monitoring and can take advantage of automated repair options when using VMSS",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "7a8ed4b3-1e38-4c3f-8981-2b2363cefe17",
      "id": "B01.01",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/extensions/health-extension",
      "graph": "resources| where type == 'microsoft.compute/virtualmachinescalesets'| where isnull(properties.virtualMachineProfile.networkProfile.healthProbe.id)| join kind=leftouter (     resources    | where type == 'microsoft.compute/virtualmachinescalesets'   | mv-expand extension=properties.virtualMachineProfile.extensionProfile.extensions    | where extension.properties.type in ( 'ApplicationHealthWindows', 'ApplicationHealthLinux' )    | project id) on id| project id, compliant = iff(isempty(id1),false,true)| union ( resources| where type == 'microsoft.compute/virtualmachines'| join kind=leftouter(  resources  | where type == 'microsoft.compute/virtualmachines/extensions'  | where properties.type in ( 'ApplicationHealthWindows', 'ApplicationHealthLinux' )  | extend    VMId = toupper(substring(id, 0, indexof(id, '/extensions'))),    ExtensionName = name) on $left.id == $right.VMId| summarize Extensions = make_list(ExtensionName) by id| project id,compliant = iff(Extensions != '[\"\"]',true,false))"
    },
    {
      "category": "VMS and VMSS",
      "subcategory": "Availability",
      "text": "When using Availability Zones, run at least two instances in each zone to ensure availability during platform updates",
      "description": "During platform updates, fault domain considerations are key for resilience. We recommend that you deploy at least two instances in a zone. Two VMs per zone guarantees a minimum of one VM in each zone because only one fault domain in a zone is updated at a time. So, for three zones, provision at least six instances.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "9b599de0-d597-43cd-9cd2-1c088137f5e6",
      "id": "B01.02",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machines/maintenance-and-updates#availability-considerations-during-scheduled-maintenance",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' and isnotnull(zones) and isnotnull(properties.virtualMachineProfile) | project id, compliant = sku.capacity < (array_length(zones) * 2)"
    },
    {
      "category": "VMSS",
      "subcategory": "Availability",
      "text": "Enable automatic repair of failed VMSS instances",
      "description": "Maintain availability even if an instance is deemed unhealthy. Automatic repairs initiate recovery by replacing the faulty instance. Consider setting a time frame during which automatic repairs pause if the VM's state changes",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "c4cfd3e5-0454-47c2-947e-c66138a7200f",
      "id": "C01.01",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-instance-repairs",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' | where isnotnull(properties.virtualMachineProfile) | project id, compliant = iff( isnull(properties.automaticRepairsPolicy) or properties.automaticRepairsPolicy.enabled == false,false,true)"
    },
    {
      "category": "VMSS",
      "subcategory": "Operations",
      "text": "Enable overprovisioning on scale sets.",
      "description": "Overprovisioning reduces deployment times and has a cost benefit because the extra VMs aren't billed.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "5135a327-452a-43cb-9396-37a55119c09e",
      "id": "C02.01",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview#overprovisioning",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' | project id, compliant = properties.overprovision" 
    },
    {
      "category": "VMSS",
      "subcategory": "Availability",
      "text": "Allow Flexible orchestration to spread the VM instances across as many fault domains as possible.",
      "description": "Using 'Max Spreading' by setting platformFaultDomainCount to '1' distributes your VMSS instances across as many fault domains as possible. However, in certain capacity-constraint scenarios, this may mean a single fault domain is used, which should be considered for stateful applications",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "80595538-7e9c-4ed1-96dd-182b09b241a9",
      "id": "C03.01",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-use-availability-zones#fault-domains-and-availability-zones",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' | project id, compliant = (properties.platformFaultDomainCount == 1)"
    },
    {
      "category": "VMSS",
      "subcategory": "Availability",
      "text": "Deploy across availability zones on scale sets. Set up at least two instances in each zone.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "99a646f7-389a-47e8-8cb7-db8cfaa62a25",
      "id": "C03.02",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' and isnotnull(zones) and isnotnull(properties.virtualMachineProfile) | project id, compliant = sku.capacity < (array_length(zones) * 2)"
    },
    {
      "category": "VMSS",
      "subcategory": "Availability",
      "text": "Enable Zone balancing to equally spreads instances across zones.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "94956ea9-8dc4-4a24-967b-2358705a1752",
      "id": "C03.03",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-use-availability-zones#zone-balancing",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' | project id, compliant = properties.zoneBalance"
    },
    {
      "category": "VMs and VMSS",
      "subcategory": "Capacity",
      "text": "Take advantage of the capacity reservations feature.",
      "description": "Capacity is reserved for your use and is available within the scope of the applicable SLAs. You can delete capacity reservations when you no longer need them, and billing is consumption based.",
      "waf": "Reliability",
      "service": "Reliability",
      "guid": "beedfa8b-488c-4eec-9862-cc3bd25bfb7f",
      "id": "D01.01",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/capacity-reservation-overview",
      "graph": "resourcecontainers| where type == 'microsoft.resources/subscriptions' | project subscriptionId| join kind=leftouter (resources | where type =~ 'Microsoft.Compute/CapacityReservationGroups' | project capacityReservationGroupId = id, subscriptionId ) on subscriptionId| project id = subscriptionId, compliant = isnotnull(capacityReservationGroupId)"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Review the security baselines for Linux and Windows VMs and Virtual Machine Scale Sets",
      "description": "As part of your baseline technology choices, consider the security features of the VM SKUs that support your workload.",
      "waf": "Security",
      "service": "Security",
      "guid": "66e9eab3-bec3-428f-9437-c1746dc56067",
      "id": "E01.01",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/security/benchmark/azure/baselines/virtual-machines-linux-security-baseline"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Ensure timely and automated security patching and upgrades",
      "description": "Use a solution like Azure Update Manager or Automatic Guest Patching to manage OS updates and maintain security compliance by making critical updates",
      "waf": "Security",
      "service": "Security",
      "guid": "a713435b-d09d-4d23-929d-b7128126504c",
      "id": "E01.02",
      "severity": "High",
      "link": "https://learn.microsoft.com/security/benchmark/azure/baselines/virtual-machines-linux-security-baseline",
      "graph": "//check for automated security patching and upgrades via maintenanceConfigurations"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Identify and secure VMs holding state data",
      "description": "Make sure that data is classified according to the sensitivity labels that your organization provided. Protect data by using security controls like appropriate levels of at-rest and in-transit encryption",
      "waf": "Security",
      "service": "Security",
      "guid": "19bf8d7e-5c58-46b7-b8cd-c05accf75ee9",
      "id": "E01.03",
      "severity": "Medium"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Enforce network segmentation with network boundaries and access controls",
      "waf": "Security",
      "service": "Security",
      "guid": "b130a888-9579-4e66-a896-e710a7da7be9",
      "id": "E01.04",
      "severity": "High",
      "link": "https://learn.microsoft.com/azure/architecture/networking/guide/network-level-segmentation"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Organize compute resources in resource groups that share the same lifecycle",
      "description": "Enables granular access control to both long-lived or shared resources and short-lived application resources",
      "waf": "Security",
      "service": "Security",
      "guid": "955d14d3-c49d-4997-ab3d-1325aa225c6f",
      "id": "E01.05",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-area/resource-org"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Use Microsoft Entra identities for authentication and authorization needs for your compute resources. Use VM managed identities where appropriate.",
      "description": "Entra identities enable stronger controls, better logging and observability, and lifecycle management than local identities",
      "waf": "Security",
      "service": "Security",
      "guid": "4d0685ed-ddea-48a4-a7cd-eb3c61fb2fc1",
      "id": "E01.06",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/how-managed-identities-work-vm"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Limit management port access to private networks or secure services such as Azure Bastion or Microsoft Defender for Cloud's Just-in-time VM access",
      "description": "Management port exposure to the open internet is a common attack vector. Using Bastion or JIT access eliminates this access.",
      "waf": "Security",
      "service": "Security",
      "guid": "4eea6e69-d8d9-4a3e-bc21-8e687ab0679c",
      "id": "E01.07",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/bastion/bastion-overviewhttps://learn.microsoft.com/azure/defender-for-cloud/just-in-time-access-overview",
      "graph": "//check for NSGs with open mgmt ports to internet"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Harden VM and VMSS machine images",
      "description": "Use pre-build hardened images available in the Azure Marketplace or custom images with unused components removed to reduce surface area",
      "waf": "Security",
      "service": "Security",
      "guid": "b49e5b96-0332-44ec-b8cc-12318ca61170",
      "id": "E01.08",
      "link": "https://learn.microsoft.com/azure/well-architected/security/harden-resources"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Implement and monitor threat detection on VMs, such as Defender for Servers",
      "waf": "Security",
      "service": "Security",
      "guid": "269f4fb4-aa3d-43ef-9f31-76c4b87b15b8",
      "id": "E01.09",
      "severity": "High",
      "link": "https://learn.microsoft.com/azure/defender-for-cloud/tutorial-enable-servers-plan",
      "graph": "//check for Defender for Servers extension enabled on VMs"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Implement threat prevention measures, such as antivirus, firewalls, and intrusion prevention systems",
      "waf": "Security",
      "service": "Security",
      "guid": "a219a4ab-eb57-4879-824d-226786d20a56",
      "id": "E01.10",
      "severity": "High"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Apply organization-recommended tags to compute resources",
      "description": "Tagging is a common way to segment and organize resources and can be crucial during incident management",
      "waf": "Security",
      "service": "Security",
      "guid": "c56a9481-19bf-48d7-b5c5-86b7d8cdc05a",
      "id": "E01.11",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging#purpose-of-naming-and-tagging",
      "graph": "resources | where type =~ 'microsoft.compute/virtualmachines' | project id, compliant = iff(isempty(tags),false,true)"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Use the securityProfile configuration on compute resources to enable your required security features, such as encryption at host. Enforce with Azure Policy as required.",
      "description": "The securityProfile portion of a VM's configuration allows you to set security properties when deploying with infrastructure-as-code",
      "waf": "Security",
      "service": "Security",
      "guid": "ccf75ee9-b130-4a88-a957-9e66b896e710",
      "id": "E01.12",
      "link": "https://learn.microsoft.com/azure/templates/microsoft.compute/virtualmachines?pivots=deployment-language-bicep#securityprofile"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Don't associate Public IP addresses directly with your compute resources",
      "description": "Assigning public IP addresses to compute resources directly makes it much easier to inadvertently expose your VM to network attacks. Doing so may also result in the bypass of network security appliances.",
      "waf": "Security",
      "service": "Security",
      "guid": "a7da7be9-955d-414d-9c49-d997cb3d1325",
      "id": "E01.13",
      "severity": "Medium",
      "graph": "//check for VMs and VMSS with ILIPs"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Use Standard SKU public IP and load balancer resources with your VMs, which are secure by default",
      "description": "Basic SKU public IPs are open to the internet by default, unless secured by a Network Security Group",
      "waf": "Security",
      "service": "Security",
      "guid": "aa225c6f-4d06-485e-bdde-a8a4b7cdeb3c",
      "id": "E01.14",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-basic-upgrade-guidance",
      "graph": "//check for Basic SKU public IPs and LBs"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Use encryption options for VM storage, such as Azure Disk Encryption",
      "waf": "Security",
      "service": "Security",
      "guid": "61fb2fc1-4eea-46e6-ad8d-9a3edc218e68",
      "id": "E01.15",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/disk-encryption-overview"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Disable public access to VM's managed disks using the disks' network access policy",
      "description": "Managed Disks can be imported and exported by URL. Restricting public access does not impact the VM's access to the disk and requires a private endpoint for the disk to be exported.",
      "waf": "Security",
      "service": "Security",
      "guid": "7ab0679c-b49e-45b9-9033-24ecf8cc1231",
      "id": "E01.16",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machines/disks-restrict-import-export-overview",
      "graph": "//check for managed disks with public access"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Security",
      "text": "Take advantage of VM Extensions to configure and secure your compute resources.",
      "description": "Extensions are used to bootstrap the VMs with the right software that protects access to and from the VMs. Microsoft-provided extensions are updated frequently to keep up with the evolving security standards.",
      "waf": "Security",
      "service": "Security",
      "guid": "c1ea55b4-6ad4-484f-aee7-2734b475ba18",
      "id": "E01.17",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machines/extensions/overview"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Implement cost guardrails",
      "description": "Use governance policies to restrict resource types, configurations, and locations. Use RBAC to block actions that can lead to overspending",
      "waf": "Cost",
      "service": "Cost",
      "guid": "fcbf590b-e65d-4e8e-83f9-bcbc468266ab",
      "id": "E02.01",
      "severity": "Medium"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Choose the right compute resource size",
      "description": "VM plan sizes and SKUs directly affect the overall cost. Choose VMs based on workload characteristics. Consider that newer generation VM SKUs offer a better price for performance ratio.",
      "waf": "Cost",
      "service": "Cost",
      "guid": "ca264e9a-19ae-4d8c-95d0-4c2b3919ca0b",
      "id": "E02.02",
      "severity": "Medium",
      "graph": "//check for resize Advsior recommondations"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Choose the right capabilities for dependant resources",
      "description": "Dependant resoruces for VMs can significantly impact cost if chosen incorrectly--for example, disk performance tier and redundancy.",
      "waf": "Cost",
      "service": "Cost",
      "guid": "2c12149e-114b-4933-bf57-4ecccd9bd3aa",
      "id": "E02.03",
      "severity": "Medium"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Use the right billing model",
      "description": "Options such as Azure Reservations, Savings Plan, and Hybrid Benefit can all make significant impacts on compute cost",
      "waf": "Cost",
      "service": "Cost",
      "guid": "fcda3b54-eb2e-4b03-bd99-2582718d2ddb",
      "id": "E02.04",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/prepay-reserved-vm-instanceshttps://learn.microsoft.com/azure/cost-management-billing/savings-plan/savings-plan-compute-overviewhttps://learn.microsoft.com/azure/cost-management-billing/scope-level/"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Continually monitor usage and right-size as needed",
      "description": "Take advantage of Azure Advisor right-size and cost recommendations to automate monitoring and alerting",
      "waf": "Cost",
      "service": "Cost",
      "guid": "10725769-ee66-491a-9824-ac932223ece7",
      "id": "E02.05",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/advisor/advisor-cost-recommendations",
      "graph": "//check for resize alerts"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Optimize cost by scaling compute resources in response to demand",
      "description": "Use Auto Scale with VMSSes and Azure Automation with VMs to automate scaling based on utilization",
      "waf": "Cost",
      "service": "Cost",
      "guid": "0b123071-a540-4641-9833-ea3ad2c2de73",
      "id": "E02.06",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overviewhttps://learn.microsoft.com/azure/azure-functions/start-stop-vms/overview",
      "graph": "//check for autoscale enabled VMSSes"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Cost",
      "text": "Consider Spot VMs and Spot Priority Mix (for VMSSes) for interruptable workloads",
      "description": "Spot VMs cost significantly less than standard priority VMs, but can be preempted and shutdown or deleted by higher priority requests ",
      "waf": "Cost",
      "service": "Cost",
      "guid": "4387e5ce-d126-4cd1-92af-5b20c6998a64",
      "id": "E02.07",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/spot-vmshttps://learn.microsoft.com/azure/virtual-machine-scale-sets/spot-priority-mix",
      "graph": "//check for Spot VMs and VMSSes"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Configure monitoring and alerting for VMs and VMSS instances",
      "description": "Collect logs and metrics from VM instances to monitor resource usage and measure the health of the instances",
      "waf": "Operations",
      "service": "Operations",
      "guid": "6e338997-e41c-477d-98cf-6a62a1194956",
      "id": "E03.01",
      "severity": "High",
      "link": "https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-log-queryhttps://learn.microsoft.com/azure/virtual-network/monitor-virtual-network#alerts",
      "graph": "resources |  where type == 'microsoft.compute/virtualmachinescalesets' | join kind=leftouter (resources | where type == 'microsoft.compute/virtualmachinescalesets' | mv-expand extension=properties.virtualMachineProfile.extensionProfile.extensions | where extension.properties.type in ('AzureMonitorWindowsAgent', 'AzureMonitorLinuxAgent') | project id) on id | project id, compliant = iff(isempty(id1), false, true) | union (resources | where type == 'microsoft.compute/virtualmachines' | join kind=leftouter(resources | where type == 'microsoft.compute/virtualmachines/extensions' | where properties.type in ('AzureMonitorWindowsAgent', 'AzureMonitorLinuxAgent') | extend VMId = toupper(substring(id, 0, indexof(id, '/extensions'))), ExtensionName = name) on $left.id == $right.VMId | summarize Extensions=make_set_if(ExtensionName,isnotempty(ExtensionName)) by id | project id, compliant = (array_length(Extensions) > 0))"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Implement Maintenance Configurations to automate patching and image upgrades during defined windows",
      "description": "Maintenance Configurations allow you to specify optimal time windows during which platform initiated maintenance may run",
      "waf": "Operations",
      "service": "Operations",
      "guid": "d697dc3a-2fd2-47b2-b187-01a1252bdedf",
      "id": "E03.02",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/maintenance-configurations",
      "graph": "//check for vms with maintenance configurations"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Automate processes for bootstrapping, running scripts, and configuring VMs and applications",
      "description": "Take advantage of Azure's automation capabilities such as Run Commands, Custom Script Extension, VM Applications, and bootstrap data to configure and manage your VMs following an infrastructure-as-code approach",
      "waf": "Operations",
      "service": "Operations",
      "guid": "68a488cd-ec48-462b-a3bd-21be77f26e5e",
      "id": "E03.03",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machines/extensions/custom-script-windowshttps://learn.microsoft.com/azure/virtual-machines/vm-applicationshttps://learn.microsoft.com/azure/virtual-machines/run-command-overview"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Implement a test environment mirroring your production.",
      "description": "Use the test environment to test changes and updates before rolling out to production",
      "waf": "Operations",
      "service": "Operations",
      "guid": "5b3bec2d-4f34-437b-8336-db55f27a61ee",
      "id": "E03.04",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-log-queryhttps://learn.microsoft.com/azure/virtual-network/monitor-virtual-network#alerts"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Enable automatic VM Extension upgrades",
      "description": "For extensions which support it, enable auto-updates to keep your VM/VMSS current as the extension is updated",
      "waf": "Operations",
      "service": "Operations",
      "guid": "e0bd05dc-2efc-45d7-91d4-1d2500cc47b4",
      "id": "E03.05",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/virtual-machines/automatic-extension-upgrade",
      "graph": "resources | where type == 'microsoft.compute/virtualmachinescalesets' | mv-expand extension=properties.virtualMachineProfile.extensionProfile.extensions | summarize extensionAutoUpdateSettings=make_set_if(tostring(extension.properties.enableAutomaticUpgrade),isnotnull(extension.properties.enableAutomaticUpgrade)) by id| project id,compliant = (extensionAutoUpdateSettings notcontains 'false') | union (resources | where type == 'microsoft.compute/virtualmachines' | join kind=leftouter(resources | where type == 'microsoft.compute/virtualmachines/extensions' | where properties.enableAutomaticUpgrade == false | extend VMId = toupper(substring(id, 0, indexof(id, '/extensions'))), ExtensionName = name) on $left.id == $right.VMId | summarize Extensions=make_set_if(ExtensionName,isnotempty(ExtensionName)) by id | project id, compliant = (array_length(Extensions) > 0))"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Deploy the Azure Monitor Agent to collect OS and application logs and metrics",
      "description": "Deploy the Azure Monitor Agent using the monitor agent extension, then associate Data Collection Rules to collect OS and application logs and metrics",
      "waf": "Operations",
      "service": "Operations",
      "guid": "93a040fd-3294-4798-a118-8b3c6a56ceb5",
      "id": "E03.06",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/azure-monitor/agents/azure-monitor-agent-overview",
      "graph": "resources |  where type == 'microsoft.compute/virtualmachinescalesets' | join kind=leftouter (resources | where type == 'microsoft.compute/virtualmachinescalesets' | mv-expand extension=properties.virtualMachineProfile.extensionProfile.extensions | where extension.properties.type in ('AzureMonitorWindowsAgent', 'AzureMonitorLinuxAgent') | project id) on id | project id, compliant = iff(isempty(id1), false, true) | union (resources | where type == 'microsoft.compute/virtualmachines' | join kind=leftouter(resources | where type == 'microsoft.compute/virtualmachines/extensions' | where properties.type in ('AzureMonitorWindowsAgent', 'AzureMonitorLinuxAgent') | extend VMId = toupper(substring(id, 0, indexof(id, '/extensions'))), ExtensionName = name) on $left.id == $right.VMId | summarize Extensions=make_set_if(ExtensionName,isnotempty(ExtensionName)) by id | project id, compliant = (array_length(Extensions) > 0))"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Operations",
      "text": "Use VM Insights to automatically configure basic VM monitor and reporting",
      "description": "VM Insights deploys the Azure Monitor Agent and a pre-defined Data Collection Rule to configure baseline monitoring for your VM",
      "waf": "Operations",
      "service": "Operations",
      "guid": "44451e1a-2d34-4529-9c76-38637a551c5c",
      "id": "E03.07",
      "severity": "Low",
      "link": "https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-overview",
      "graph": "//check for VMs and VMSSes without insights DCR association"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Performance",
      "text": "Define and track performance targets for applications on your Azure compute resources",
      "description": "Identify VM metrics to track and measure against performance indicators as response time, CPU utilization, and memory utilization, as well as workload metrics such as transactions per second, concurrent users, and availability and health",
      "waf": "Performance",
      "service": "Performance",
      "guid": "04e4f195-4387-4e5c-bd12-6cd132af5b20",
      "id": "E04.01",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-log-queryhttps://learn.microsoft.com/azure/virtual-network/monitor-virtual-network#alerts"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Performance",
      "text": "Consider dependant services impact on application performance",
      "description": "Workload dependencies, like caching, network traffic, and content delivery networks, that interact with the VMs can affect performance. Also, consider geographical distribution, like zones and regions, which can add latency",
      "waf": "Performance",
      "service": "Performance",
      "guid": "c6998a64-6e33-4899-9e41-c77d68cf6a62",
      "id": "E04.02",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-log-queryhttps://learn.microsoft.com/azure/virtual-network/monitor-virtual-network#alerts"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Performance",
      "text": "Use Proximity Placement Groups to ensure dependant VMs are provisioned close to each other",
      "description": "PPGs introduce a requirement that VMs are provisioned close to each other in the chosen region and zone. ",
      "waf": "Performance",
      "service": "Performance",
      "guid": "a1194956-d697-4dc3-a2fd-27b2e18701a1",
      "id": "E04.03",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machine-scale-sets/proximity-placement-groups",
      "graph": "resources | where type =~ 'Microsoft.Compute/proximityPlacementGroups' | summarize ppgCount = count() | project id = 'na',compliant = (ppgCount > 0)"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Performance",
      "text": "Select the appropriate storage performance tier and features to support your workload",
      "description": "Premium and Ultra SKU storage deliver enhanced performance. Selecting an NVMe bus type can improve storage performance as well.",
      "waf": "Performance",
      "service": "Performance",
      "guid": "252bdedf-68a4-488c-bec4-862bc3bd21be",
      "id": "E04.04",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-machines/disks-types"
    },
    {
      "category": "VM and VMSS",
      "subcategory": "Performance",
      "text": "Enable Accelerated Networking to greatly improve VM to VM network performance",
      "waf": "Performance",
      "service": "Performance",
      "guid": "77f26e5e-5b3b-4ec2-b4f3-437b1336db55",
      "id": "E04.05",
      "severity": "Medium",
      "link": "https://learn.microsoft.com/azure/virtual-network/accelerated-networking-overview",
      "graph": "resources| where type == 'microsoft.compute/virtualmachines'| project id = tolower(id)| join kind=leftouter (   resources   | where type == 'microsoft.network/networkinterfaces' and properties.enableAcceleratedNetworking == true  | project attachedVMId = tolower(properties.virtualMachine.id),nicId = id  ) on $left.id == $right.attachedVMId| summarize attachedANNICIds=make_set_if(nicId, isnotempty(nicId)) by id| project id,compliant = array_length(attachedANNICIds) > 0| union ( resources |where type == 'microsoft.compute/virtualmachinescalesets' and id == '/subscriptions/24730882-456b-42df-a6f8-8590ca6e4e37/resourceGroups/rg-ramon/providers/Microsoft.Compute/virtualMachineScaleSets/vmss-predictiveautoscale-test-01'| extend acceleratedNetworkingEnabled = extract(@'\"enableAcceleratedNetworking\":(true|false)',1,tostring(properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations),typeof(bool))| project id,compliant = acceleratedNetworkingEnabled)"
    }
  ],
  "categories": [
    {
      "name": "Identity and Access Management"
    },
    {
      "name": "Network Topology and Connectivity"
    },
    {
      "name": "BC and DR"
    },
    {
      "name": "Governance and Security"
    },
    {
      "name": "Cost Governance"
    },
    {
      "name": "Operations"
    },
    {
      "name": "Application Deployment"
    }
  ],
  "waf": [
    {
      "name": "Reliability"
    },
    {
      "name": "Security"
    },
    {
      "name": "Cost"
    },
    {
      "name": "Operations"
    },
    {
      "name": "Performance"
    }
  ],
  "yesno": [
    {
      "name": "Yes"
    },
    {
      "name": "No"
    }
  ],
  "status": [
    {
      "name": "Not verified",
      "description": "This check has not been looked at yet"
    },
    {
      "name": "Open",
      "description": "There is an action item associated to this check"
    },
    {
      "name": "Fulfilled",
      "description": "This check has been verified, and there are no further action items associated to it"
    },
    {
      "name": "Not required",
      "description": "Recommendation understood, but not needed by current requirements"
    },
    {
      "name": "N/A",
      "description": "Not applicable for current design"
    }
  ],
  "severities": [
    {
      "name": "High"
    },
    {
      "name": "Medium"
    },
    {
      "name": "Low"
    }
  ],
  "metadata": {
    "name": "Virtual Machines",
    "state": "preview",
    "waf": "all",
    "timestamp": "09/27/2024 14:34:01"
  }
}

