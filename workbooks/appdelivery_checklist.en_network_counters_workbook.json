{
    "version": "Notebook/1.0",
    "items": [
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "parameters": [
                    {
                        "id": "497a107e-dde8-433e-b263-35ac8e8f7834",
                        "version": "KqlParameterItem/1.0",
                        "name": "Subscription",
                        "type": 6,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "typeSettings": {
                            "additionalResourceOptions": [
                                "value::all"
                            ],
                            "includeAll": true,
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "value": [
                            "value::all"
                        ]
                    },
                    {
                        "id": "844e4f4e-df51-4e3c-8eaf-0dc78b92c721",
                        "version": "KqlParameterItem/1.0",
                        "name": "OnlyFailed",
                        "label": "Only show failed",
                        "type": 2,
                        "typeSettings": {
                            "additionalResourceOptions": [],
                            "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":true, \"label\":\"True\" },\r\n    { \"value\":false, \"label\":\"False\", \"selected\":true }\r\n]"
                    }
                ],
                "style": "pills",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "WorkbookSelectors"
        },
        {
            "type": 1,
            "content": {
                "json": "If you set \"Only show failed\" to \"Yes\", the different queries will only show items that have failed their compliance checks.",
                "style": "info"
            },
            "name": "InfoBox"
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "crossComponentResources": [
                    "value::all"
                ],
                "parameters": [
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query0Stats",
                        "type": 1,
                        "query": "resources | where type == 'microsoft.network/applicationgateways' | project id, compliant = properties.sku.name in ('Standard_v2', 'WAF_v2') | project id,compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query0FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query0Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query1Stats",
                        "type": 1,
                        "query": "resources | where type == 'microsoft.network/loadbalancers' | project id, compliant=(tolower(sku.name) == 'standard')| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query1FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query1Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query2Stats",
                        "type": 1,
                        "query": "resources | where type=='microsoft.network/applicationgateways' | extend subnetId = tostring(properties.gatewayIPConfigurations[0].properties.subnet.id) | project id, subnetId | join (resources | where type=='microsoft.network/virtualnetworks' | project id,subnets=properties.subnets | mv-expand subnets | mv-expand subnets.properties.addressPrefixes | project id, subnetId = tostring(subnets.id), prefix1 = subnets.properties.addressPrefix, prefix2 = subnets.properties.addressPrefixes | mv-expand prefix2 | extend prefix = iff(isnotnull(prefix1), prefix1, prefix2) | extend subnetPrefixLength = split(prefix, '/')[1])on subnetId | extend compliant = (subnetPrefixLength <= 24 or subnetPrefixLength == 64) | distinct id,compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query2FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query2Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query3Stats",
                        "type": 1,
                        "query": "resources | where type =~ 'microsoft.network/applicationGateways' | extend compliant = (isnotnull(properties.autoscaleConfiguration) and properties.autoscaleConfiguration.minCapacity >= 2) | distinct id,compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query3FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query3Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query4Stats",
                        "type": 1,
                        "query": "resources | where type =~ 'microsoft.network/applicationGateways' | extend compliant = (isnotnull(zones) and array_length(zones) > 1) | distinct id,compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query4FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query4Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query5Stats",
                        "type": 1,
                        "query": "resources | where type=='microsoft.network/loadbalancers' | extend countOutRules=array_length(properties.outboundRules) | extend compliant = (countOutRules == 0) | distinct id,compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query5FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query5Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query6Stats",
                        "type": 1,
                        "query": "resources | where type == 'microsoft.network/applicationgatewaywebapplicationfirewallpolicies' | mv-expand properties.managedRules.managedRuleSets | project id, rulesettype = properties_managedRules_managedRuleSets.ruleSetType | extend compliant1 = (rulesettype == 'Microsoft_BotManagerRuleSet') | project id, compliant1 | summarize compliant = max(compliant1) by id| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query6FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query6Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query7Stats",
                        "type": 1,
                        "query": "resources | where type =~ 'microsoft.network/applicationgatewaywebapplicationfirewallpolicies' | extend compliant = (properties['policySettings']['requestBodyCheck'] == 'true' and properties['policySettings']['state'] =~ 'Enabled') | distinct id, name, compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query7FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query7Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query8Stats",
                        "type": 1,
                        "query": "resources | where type =~ 'microsoft.network/applicationgatewaywebapplicationfirewallpolicies' | extend compliant = (properties['policySettings']['mode'] =~ 'Prevention')| where properties['policySettings']['mode'] =~ 'Prevention' | distinct id, name, compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query8FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query8Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query9Stats",
                        "type": 1,
                        "query": "resources | where type == 'microsoft.network/applicationgateways'| extend compliant = (properties['backendHttpSettingsCollection'][0]['properties']['port'] =~ '443') |where properties['backendHttpSettingsCollection'][0]['properties']['port'] =~ '443'|distinct id,name,compliant| summarize Total = count(), Success = countif(compliant==1), Failed = countif(compliant==0) | extend SuccessPercent = iff(Total==0, 100, 100*toint(Success)/toint(Total)) | extend FullyCompliant = iff(SuccessPercent == 100, 'Yes', 'No') | project Query1Stats=tostring(pack_all())",
                        "crossComponentResources": [
                            "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Query9FullyCompliant",
                        "type": 1,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\": \\\"{Query9Stats:$.FullyCompliant}\\\"}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "queryType": 8
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Tab0Success",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "{Query0Stats:$.Success}+{Query2Stats:$.Success}+{Query3Stats:$.Success}+{Query4Stats:$.Success}+{Query6Stats:$.Success}+{Query7Stats:$.Success}+{Query8Stats:$.Success}+{Query9Stats:$.Success}"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Tab0Total",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "{Query0Stats:$.Total}+{Query2Stats:$.Total}+{Query3Stats:$.Total}+{Query4Stats:$.Total}+{Query6Stats:$.Total}+{Query7Stats:$.Total}+{Query8Stats:$.Total}+{Query9Stats:$.Total}"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Tab0Percent",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "round(100*{Tab0Success}/{Tab0Total})"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Tab1Success",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "{Query1Stats:$.Success}+{Query5Stats:$.Success}"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Tab1Total",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "{Query1Stats:$.Total}+{Query5Stats:$.Total}"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "Tab1Percent",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "round(100*{Tab1Success}/{Tab1Total})"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "WorkbookTotal",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "{Query0Stats:$.Total}+{Query2Stats:$.Total}+{Query3Stats:$.Total}+{Query4Stats:$.Total}+{Query6Stats:$.Total}+{Query7Stats:$.Total}+{Query8Stats:$.Total}+{Query9Stats:$.Total}+{Query1Stats:$.Total}+{Query5Stats:$.Total}"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "WorkbookSuccess",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "{Query0Stats:$.Success}+{Query2Stats:$.Success}+{Query3Stats:$.Success}+{Query4Stats:$.Success}+{Query6Stats:$.Success}+{Query7Stats:$.Success}+{Query8Stats:$.Success}+{Query9Stats:$.Success}+{Query1Stats:$.Success}+{Query5Stats:$.Success}"
                                }
                            }
                        ]
                    },
                    {
                        "id": "daf05c62-1d5b-4325-b241-d7ee468f23eb",
                        "version": "KqlParameterItem/1.0",
                        "name": "WorkbookPercent",
                        "type": 1,
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "criteriaData": [
                            {
                                "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "expression",
                                    "resultVal": "round(100*{WorkbookSuccess}/{WorkbookTotal})"
                                }
                            }
                        ]
                    }
                ],
                "style": "pills",
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "InvisibleParameters"
        },
        {
            "type": 1,
            "content": {
                "json": "## Azure Application Delivery Networking - Network\n\n---\n\nThis workbook has been automatically generated out of the checklists in the [Azure Review Checklists repo](https://github.com/Azure/review-checklists). This repo contains best practices and recommendations around generic Landing Zones as well as specific services such as Azure Virtual Desktop, Azure Kubernetes Service or Azure VMware Solution, to name a few. This repository of best practices is curated by Azure engineers, but open to anybody to contribute.\n\nIf you see a problem in the queries that are part of this workbook, please open a Github issue [here](https://github.com/Azure/review-checklists/issues/new)."
            },
            "customWidth": "50",
            "name": "MarkdownHeader"
        },
        {
            "type": 3,
            "content": {
                "version": "KqlItem/1.0",
                "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"WorkbookPercent\\\": \\\"{WorkbookPercent}\\\", \\\"SubTitle\\\": \\\"Percent of successful checks\\\"}\",\"transformers\":null}",
                "size": 4,
                "queryType": 8,
                "visualization": "tiles",
                "tileSettings": {
                    "titleContent": {
                        "columnMatch": "WorkbookPercent",
                        "formatter": 4,
                        "formatOptions": {
                            "min": 0,
                            "max": 100,
                            "palette": "redGreen"
                        }
                    },
                    "subtitleContent": {
                        "columnMatch": "SubTitle",
                        "formatter": 1
                    },
                    "showBorder": true
                }
            },
            "customWidth": "50",
            "name": "ProgressTile"
        },
        {
            "type": 11,
            "content": {
                "version": "LinkItem/1.0",
                "style": "tabs",
                "links": [
                    {
                        "id": "aa0fe644-f1b8-4807-912c-ab154dae6729",
                        "cellValue": "VisibleTab",
                        "linkTarget": "parameter",
                        "linkLabel": "App Gateway ({Tab0Success:value}/{Tab0Total:value})",
                        "subTarget": "tab0",
                        "preText": "App Gateway",
                        "style": "primary"
                    },
                    {
                        "id": "1f363698-b32e-4e8c-9ed8-7b706a990e5f",
                        "cellValue": "VisibleTab",
                        "linkTarget": "parameter",
                        "linkLabel": "Load Balancer ({Tab1Success:value}/{Tab1Total:value})",
                        "subTarget": "tab1",
                        "preText": "Load Balancer",
                        "style": "primary"
                    }
                ]
            },
            "name": "Tabs"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "## App Gateway"
                        },
                        "name": "tab0title"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Ensure you are using Application Gateway v2 SKU. Check [this link](https://learn.microsoft.com/azure/application-gateway/overview-v2) for further information.. [This training](https://learn.microsoft.com/learn/paths/secure-application-delivery/) can help to educate yourself on this."
                        },
                        "name": "querytext0"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type == 'microsoft.network/applicationgateways' | project id, compliant = properties.sku.name in ('Standard_v2', 'WAF_v2') | project id,compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query0"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Your Application Gateways v2 should be deployed in subnets with IP prefixes equal or larger than /24. Check [this link](https://learn.microsoft.com/azure/application-gateway/configuration-infrastructure#size-of-the-subnet) for further information.. [This training](https://learn.microsoft.com/learn/paths/secure-application-delivery/) can help to educate yourself on this."
                        },
                        "name": "querytext2"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type=='microsoft.network/applicationgateways' | extend subnetId = tostring(properties.gatewayIPConfigurations[0].properties.subnet.id) | project id, subnetId | join (resources | where type=='microsoft.network/virtualnetworks' | project id,subnets=properties.subnets | mv-expand subnets | mv-expand subnets.properties.addressPrefixes | project id, subnetId = tostring(subnets.id), prefix1 = subnets.properties.addressPrefix, prefix2 = subnets.properties.addressPrefixes | mv-expand prefix2 | extend prefix = iff(isnotnull(prefix1), prefix1, prefix2) | extend subnetPrefixLength = split(prefix, '/')[1])on subnetId | extend compliant = (subnetPrefixLength <= 24 or subnetPrefixLength == 64) | distinct id,compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query2"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Configure autoscaling with a minimum amount of instances of two. Check [this link](https://learn.microsoft.com/azure/application-gateway/application-gateway-autoscaling-zone-redundant) for further information.. [This training](https://learn.microsoft.com/learn/paths/secure-application-delivery/) can help to educate yourself on this."
                        },
                        "name": "querytext3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type =~ 'microsoft.network/applicationGateways' | extend compliant = (isnotnull(properties.autoscaleConfiguration) and properties.autoscaleConfiguration.minCapacity >= 2) | distinct id,compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query3"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Deploy Application Gateway across Availability Zones. Check [this link](https://learn.microsoft.com/azure/reliability/migrate-app-gateway-v2) for further information.. [This training](https://learn.microsoft.com/learn/paths/secure-application-delivery/) can help to educate yourself on this."
                        },
                        "name": "querytext4"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type =~ 'microsoft.network/applicationGateways' | extend compliant = (isnotnull(zones) and array_length(zones) > 1) | distinct id,compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query4"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Enable the Azure Application Gateway WAF bot protection rule set. The bot rules detect good and bad bots. Check [this link](https://learn.microsoft.com/azure/web-application-firewall/ag/bot-protection) for further information."
                        },
                        "name": "querytext6"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type == 'microsoft.network/applicationgatewaywebapplicationfirewallpolicies' | mv-expand properties.managedRules.managedRuleSets | project id, rulesettype = properties_managedRules_managedRuleSets.ruleSetType | extend compliant1 = (rulesettype == 'Microsoft_BotManagerRuleSet') | project id, compliant1 | summarize compliant = max(compliant1) by id | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query6"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Ensure if request body inspection feature is enabled in Azure Application Gateway WAF policy. Check [this link](https://learn.microsoft.com/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits#request-body-inspection) for further information."
                        },
                        "name": "querytext7"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type =~ 'microsoft.network/applicationgatewaywebapplicationfirewallpolicies' | extend compliant = (properties['policySettings']['requestBodyCheck'] == 'true' and properties['policySettings']['state'] =~ 'Enabled') | distinct id, name, compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query7"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Deploy your WAF policy for Application Gateway in 'Prevention' mode. Check [this link](https://learn.microsoft.com/azure/web-application-firewall/ag/policy-overview?source=recommendations) for further information."
                        },
                        "name": "querytext8"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type =~ 'microsoft.network/applicationgatewaywebapplicationfirewallpolicies' | extend compliant = (properties['policySettings']['mode'] =~ 'Prevention')| where properties['policySettings']['mode'] =~ 'Prevention' | distinct id, name, compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query8"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "You should encrypt traffic to the backend servers. Check [this link](https://learn.microsoft.com/azure/application-gateway/ssl-overview) for further information."
                        },
                        "name": "querytext9"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type == 'microsoft.network/applicationgateways'| extend compliant = (properties['backendHttpSettingsCollection'][0]['properties']['port'] =~ '443') |where properties['backendHttpSettingsCollection'][0]['properties']['port'] =~ '443'|distinct id,name,compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query9"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "VisibleTab",
                "comparison": "isEqualTo",
                "value": "tab0"
            },
            "name": "tab0"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "## Load Balancer"
                        },
                        "name": "tab1title"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Ensure you are using the Standard SKU for your Azure Load Balancers. Check [this link](https://learn.microsoft.com/azure/load-balancer/load-balancer-overview) for further information."
                        },
                        "name": "querytext1"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type == 'microsoft.network/loadbalancers' | project id, compliant=(tolower(sku.name) == 'standard') | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query1"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "Use Azure NAT Gateway instead of Load Balancer outbound rules for better SNAT scalability. Check [this link](https://learn.microsoft.com/azure/nat-gateway/nat-overview#outbound-connectivity) for further information."
                        },
                        "name": "querytext5"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "resources | where type=='microsoft.network/loadbalancers' | extend countOutRules=array_length(properties.outboundRules) | extend compliant = (countOutRules == 0) | distinct id,compliant | extend onlyFailed = {OnlyFailed:label} | where compliant == 0 or not (onlyFailed == 1) | project-away onlyFailed",
                            "size": 4,
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources",
                            "crossComponentResources": [
                                "{Subscription}"
                            ],
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "id",
                                        "formatter": 0,
                                        "numberFormat": {
                                            "unit": 0,
                                            "options": {
                                                "style": "decimal"
                                            }
                                        }
                                    },
                                    {
                                        "columnMatch": "compliant",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": "Success"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "0",
                                                    "representation": "failed",
                                                    "text": "Failed"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "Unknown"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query5"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "VisibleTab",
                "comparison": "isEqualTo",
                "value": "tab1"
            },
            "name": "tab1"
        }
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}